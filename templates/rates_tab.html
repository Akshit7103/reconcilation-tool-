<!DOCTYPE html>
<html>
<head>
    <title>Rates File</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <nav class="tab-nav">
            <a class="tab-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">Reconciliation Files</a>
            <a class="tab-link {% if request.endpoint == 'rates_file' %}active{% endif %}" href="{{ url_for('rates_file') }}">Rates File</a>
        </nav>
        <h1>Rates File</h1>

        {% if error_message %}
            <div class="error-message">
                <strong>Error:</strong> {{ error_message }}
            </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" class="rates-form">
            <div class="form-section">
                <h3>Required Files</h3>
                <div class="form-grid">
                    <div class="field required">
                        <label for="summary_file">Summary File <span class="required">*</span></label>
                        <input type="file" id="summary_file" name="summary_file" accept=".xls,.xlsx" required>
                        <small class="file-hint">Primary fee rate workbook with calculation formulas</small>
                    </div>

                    <div class="field">
                        <label for="invoice_file">Invoice File (for VISA Amount comparison)</label>
                        <input type="file" id="invoice_file" name="invoice_file" accept=".xls,.xlsx">
                        <small class="file-hint"><strong>Recommended:</strong> Excel file containing actual invoice amounts for comparison. Without this, VISA Amount column will show "N/A".</small>
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>Optional Data Files</h3>
                <div class="form-grid">
                    <div class="field">
                        <label for="card_file">Card Issuance Report</label>
                        <input type="file" id="card_file" name="card_file" accept=".xls,.xlsx">
                        <small class="file-hint">For card-based fee calculations</small>
                    </div>

                    <div class="field">
                        <label for="international_file">International Transactions</label>
                        <input type="file" id="international_file" name="international_file" accept=".xls,.xlsx">
                        <small class="file-hint">For international transaction fees</small>
                    </div>

                    <div class="field">
                        <label for="domestic_file">Domestic Transactions</label>
                        <input type="file" id="domestic_file" name="domestic_file" accept=".xls,.xlsx">
                        <small class="file-hint">For domestic transaction fees</small>
                    </div>

                    <div class="field">
                        <label for="dispute_file">VROL / Dispute Transactions</label>
                        <input type="file" id="dispute_file" name="dispute_file" accept=".xls,.xlsx">
                        <small class="file-hint">For dispute-related fees</small>
                    </div>
                </div>
            </div>

            <div class="submit-section">
                <button type="submit" class="btn-primary">Run Rate Analysis</button>
            </div>
        </form>

        {% if report %}
            <section class="rate-dashboard">
                <div class="rate-metrics">
                    <div class="metric-card reconciled">
                        <span class="metric-label">Amount Reconciled</span>
                        <span class="metric-value-large">{{ report.summary.amount_reconciled_display }}</span>
                        <div class="metric-subgrid">
                            <div class="metric-sub">
                                <span class="metric-sub-label">Fee Reconciled</span>
                                <span class="metric-sub-value">{{ report.summary.fee_reconciled_display }}</span>
                            </div>
                            <div class="metric-sub">
                                <span class="metric-sub-label">Item Reconciled</span>
                                <span class="metric-sub-value">{{ report.summary.matched_items }}/{{ report.summary.total_visa_items }}</span>
                            </div>
                            <div class="metric-sub">
                                <span class="metric-sub-label">Match %</span>
                                <span class="metric-sub-value">{{ report.summary.amount_match_display }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">Fee Mappings</span>
                        <span class="metric-value">{{ report.summary.total_mappings }}</span>
                    </div>
                    <div class="metric-card emphasis">
                        <span class="metric-label">Calculated Total</span>
                        <span class="metric-value">{{ report.summary.total_final_amount_display }}</span>
                    </div>
                    <div class="metric-card">
                        <span class="metric-label">VISA Total</span>
                        <span class="metric-value">{{ report.summary.total_visa_amount_display }}</span>
                    </div>
                </div>

                {% if report.warnings %}
                <div class="rate-panel warning">
                    <h2>Warnings</h2>
                    <ul>
                        {% for warning in report.warnings %}
                        <li>{{ warning }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                <div class="rate-panels">
                    {% if report.card %}
                    <div class="rate-panel">
                        <h2>Card Issuance Snapshot</h2>
                        <p class="stat">Total Cards: <strong>{{ report.card.total_cards }}</strong></p>
                        {% if report.card.monthly_data %}
                        <table class="data-table compact">
                            <thead>
                                <tr>
                                    <th>Period</th>
                                    <th>Cards</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in report.card.monthly_data %}
                                <tr>
                                    <td>{{ entry.period }}</td>
                                    <td>{{ entry.cards }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <p class="muted">No periodic breakdown detected.</p>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if report.transactions %}
                    <div class="rate-panel">
                        <h2>Transaction Overview</h2>
                        <div class="transaction-grid">
                            {% for item in report.transactions.entries %}
                            <div class="transaction-card">
                                <span class="transaction-label">{{ item.label }}</span>
                                <span class="transaction-amount">{{ item.amount_display }}</span>
                                <span class="transaction-volume">Volume: {{ item.volume }}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if report.sheets %}
                <div class="rate-panel">
                    <h2>Fee Details by Sheet</h2>
                    {% for sheet in report.sheets %}
                    <article class="sheet-block">
                        <header class="sheet-header">
                            <h3>{{ sheet.name }}</h3>
                        </header>
                        <div class="table-container">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Fee Type</th>
                                        <th>Rate Chart</th>
                                        <th>Calculation Method</th>
                                        <th>Calculated Amount</th>
                                        <th>Exchange Rate</th>
                                        <th>Calculated Value (INR)</th>
                                        <th>VISA Amount (INR)</th>
                                        <th>% Difference</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in sheet.rows %}
                                    <tr>
                                        <td>{{ row.fee_type }}</td>
                                        <td>{{ row.rate_chart }}</td>
                                        <td>{{ row.calculation_method }}</td>
                                        <td>{{ row.calculated_amount_display }}</td>
                                        <td>{% if row.exchange_rate %}{{ row.exchange_rate }}{% else %}&mdash;{% endif %}</td>
                                        <td class="{% if row.final_amount_display == 'Missing' %}text-warning{% endif %}">{{ row.final_amount_display }}</td>
                                        <td>{{ row.visa_amount_display }}</td>
                                        <td class="diff-{{ row.diff_status }}">{{ row.percentage_diff_display }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </article>
                    {% endfor %}
                </div>
                {% else %}
                    <div class="rate-panel">
                        <p class="muted">No fee mappings were identified in the provided summary workbook.</p>
                    </div>
                {% endif %}
            </section>
        {% endif %}
    </div>
</body>
</html>
